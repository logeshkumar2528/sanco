@using System.Web
@{
    ViewBag.Title = "Bond Gate In - Edit log Compare";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var gid = (int)ViewBag.GIDNO;
    var verA = (string)ViewBag.VersionA;
    var verB = (string)ViewBag.VersionB;
    var rowsA = (IEnumerable<scfs_erp.Models.GateInDetailEditLogRow>)ViewBag.RowsA;
    var rowsB = (IEnumerable<scfs_erp.Models.GateInDetailEditLogRow>)ViewBag.RowsB;

    Func<scfs_erp.Models.GateInDetailEditLogRow, string> pickVal = r => string.IsNullOrEmpty(r.NewValue) ? (r.OldValue ?? "") : r.NewValue;

    // Map database field names to user-friendly display names
    var fieldNameMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        {"GIDATE", "Gate In Date"}, {"GITIME", "Gate In Time"},
        {"GINO", "Gate In No"}, {"GIDNO", "Gate In Detail No"}, {"IGMNO", "IGM No"},
        {"GPLNO", "GPL No"},
        {"CONTNRNO", "Container No"}, {"CONTNRSID", "Container Size"}, {"CONTNRTID", "Container Type"},
        {"VHLNO", "Vehicle No"}, {"DRVNAME", "Driver Name"},
        {"TRNSPRTNAME", "Transporter Name"}, {"IMPRTNAME", "Importer Name"}, {"STMRNAME", "Shipping Line Name"},
        {"CHANAME", "CHA Name"},
        {"VOYNO", "Voyage No"},
        {"PRDTDESC", "Product Description"}, {"PRDTGID", "Product Category"}, {"PRDTTID", "Cargo Type"},
        {"GPWGHT", "Weight"}, {"GPNOP", "NOP"}, {"GPCBM", "CBM"},
        {"BNDID", "Bond ID"}, {"BNDDNO", "Bondno"},
        {"CONTNRRCVFRM", "Cargo Received From"}, {"CONTNRRCVFRMOTH", "Received From (Others)"},
        {"GIREMKRS", "Remarks"}, {"DISPSTATUS", "Status"},
        // Bond-related fields from bond information
        {"BNDTYPE", "Bond Type"}, {"BND20", "20\""}, {"BND40", "40\""},
        {"BNDGWGHT", "Bond Grs.Weight"}, {"BNDNOP", "Bond NOP"}, {"BNDSPC", "Bond Space"},
        {"BNDBENO", "BE No"}, {"BNDBEDATE", "BE Date"}, {"BNDBLNO", "BL Number"}, {"BNDBLDATE", "BL Date"}
    };
    
    // Fields to always display (even if they're the same)
    var alwaysDisplayFields = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
    {
        "Bond Type", "BNDTYPE",
        "20\"", "BND20",
        "40\"", "BND40",
        "Bond Grs.Weight", "BNDGWGHT",
        "Bond NOP", "BNDNOP",
        "Bond Space", "BNDSPC",
        "BE No", "BNDBENO",
        "BE Date", "BNDBEDATE",
        "BL Number", "BNDBLNO",
        "BL Date", "BNDBLDATE",
        "Bondno", "BNDDNO"
    };
    
    // Fields to exclude from display
    var excludedFields = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
    {
        "VSLNAME"
    };
    
    Func<string, string> getFriendlyName = fieldName => 
    {
        if (fieldNameMap.ContainsKey(fieldName)) return fieldNameMap[fieldName];
        // Try to clean up field name by removing underscores and suffixes
        var cleaned = fieldName.Replace("_", " ").Replace(" (GID)", "").Trim();
        return cleaned;
    };

    // Build dictionaries keyed by field name for both versions
    var dictA = rowsA
        .GroupBy(r => r.FieldName)
        .ToDictionary(g => g.Key, g => pickVal(g.Last()));
    var dictB = rowsB
        .GroupBy(r => r.FieldName)
        .ToDictionary(g => g.Key, g => pickVal(g.Last()));

    // Show ALL fields from both versions (Union instead of Intersect)
    var allFields = dictA.Keys.Union(dictB.Keys).OrderBy(k => k).ToList();
}

<style>
    .diff-yes { background: #fff3cd; }
    .diff-no { background: #e8f5e9; }
    .new-field { background: #d9edf7; border-left: 4px solid #31708f; }
    .sticky th { position: sticky; top: 0; background: #2e3e4e; color: #fff; z-index: 2; }
    .nowrap { white-space: nowrap; }
    .filterbar { margin: 10px 0; }
    .old-badge { background: #f2dede; color: #a94442; border-radius: 3px; padding: 2px 6px; display: inline-block; }
    .new-badge { background: #dff0d8; color: #3c763d; border-radius: 3px; padding: 2px 6px; display: inline-block; }
    .empty-value { color: #999; font-style: italic; }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2 class="page-header">Bond Gate In - Version Compare</h2>
            <p class="text-muted">
                Comparing <strong>GateIn Number</strong> <code>@gid</code> between <strong>Version A</strong> <code>@verA</code> and <strong>Version B</strong> <code>@verB</code>.
                <br/>
                <span id="changedCount" style="color: #31708f; font-weight: bold;"></span>
            </p>
            <div class="btn-group">
                <a class="btn btn-default" href="@Url.Action("EditLogGateIn", "BondGateIn", new { gidid = gid })"><i class="fa fa-arrow-left"></i> Back to Log</a>
            </div>
            <div class="filterbar">
                <label>Filter field:</label>
                <input type="text" id="fltField" class="form-control input-sm" style="display:inline-block; width:220px;" placeholder="Type to filter fields..." />
            </div>
            <div class="alert alert-info" style="margin-top: 10px;">
                <strong>Note:</strong> Showing all fields from both versions. 
                <span style="background: #fff3cd; padding: 2px 8px; margin: 0 10px; border-radius: 3px;">Yellow = Changed Field</span>
                <span style="background: #e8f5e9; padding: 2px 8px; margin: 0 10px; border-radius: 3px;">Green = Unchanged Field</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table id="cmpTable" class="table table-bordered table-striped sticky">
                    <thead>
                        <tr>
                            <th class="nowrap">Field</th>
                            <th class="nowrap">Old Value (Version @verA)</th>
                            <th class="nowrap">New Value (Version @verB)</th>
                        </tr>
                        <tr>
                            <th><input type="text" id="fltField2" class="form-control input-sm" placeholder="Field" /></th>
                            <th><input type="text" id="fltOld" class="form-control input-sm" placeholder="Old value" /></th>
                            <th><input type="text" id="fltNew" class="form-control input-sm" placeholder="New value" /></th>
                        </tr>
                    </thead>
                    <tbody>
                    @{
                        var changedFieldsCount = 0;
                    }
                    @if (allFields.Count == 0)
                    {
                        <tr>
                            <td colspan="3" class="text-center text-muted">No fields found</td>
                        </tr>
                    }
                    else
                    {
                        var seenFields = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
                        foreach (var f in allFields)
                        {
                            // Filter out excluded fields
                            var fieldName = f ?? string.Empty;
                            var friendlyFieldName = getFriendlyName(fieldName);
                            if (excludedFields.Contains(fieldName) || excludedFields.Contains(friendlyFieldName))
                            {
                                continue;
                            }
                            
                            // Skip duplicate "Cargo Type" - if PRDTTID appears, skip CONTNRRCVFRM if it's also labeled as "Cargo Type"
                            // CONTNRRCVFRM should be "Cargo Received From", not "Cargo Type"
                            if (fieldName.Equals("PRDTTID", StringComparison.OrdinalIgnoreCase))
                            {
                                seenFields.Add("Cargo Type");
                            }
                            else if (fieldName.Equals("CONTNRRCVFRM", StringComparison.OrdinalIgnoreCase) && friendlyFieldName.Equals("Cargo Type", StringComparison.OrdinalIgnoreCase))
                            {
                                // Skip if we already have PRDTTID (Cargo Type)
                                if (seenFields.Contains("Cargo Type"))
                                {
                                    continue;
                                }
                            }
                            
                            var va = dictA.ContainsKey(f) ? dictA[f] : "";
                            var vb = dictB.ContainsKey(f) ? dictB[f] : "";
                            
                            // Check if this field should always be displayed
                            bool shouldAlwaysDisplay = alwaysDisplayFields.Contains(f) || alwaysDisplayFields.Contains(friendlyFieldName);
                            
                            // Check if comparing with baseline (V0)
                            var verAUpper = (verA ?? "").ToUpper();
                            var verBUpper = (verB ?? "").ToUpper();
                            bool isV0A = verAUpper.StartsWith("V0-") || verAUpper == "0" || verAUpper == "V0";
                            bool isV0B = verBUpper.StartsWith("V0-") || verBUpper == "0" || verBUpper == "V0";
                            bool comparingWithBaseline = isV0A || isV0B;
                            
                            // When comparing with baseline, show all fields from the non-baseline version
                            // When comparing two edit versions, show fields that exist in both versions
                            // But always show fields in alwaysDisplayFields
                            if (comparingWithBaseline)
                            {
                                // Show all fields that exist in at least one version OR should always be displayed
                                if (shouldAlwaysDisplay || !string.IsNullOrEmpty(va) || !string.IsNullOrEmpty(vb))
                                {
                                    changedFieldsCount++;
                                    bool diff = (va ?? "") != (vb ?? "");
                                    var rowClass = diff ? "diff-yes" : "diff-no";
                                    
                                    <tr class="row-item @rowClass" data-field="@f">
                                        <td class="field-name">@friendlyFieldName</td>
                                        <td>
                                            <span class="old-badge">@Html.Raw(HttpUtility.HtmlEncode(string.IsNullOrEmpty(va) ? "(not set)" : va))</span>
                                        </td>
                                        <td>
                                            <span class="new-badge">@Html.Raw(HttpUtility.HtmlEncode(string.IsNullOrEmpty(vb) ? "(not set)" : vb))</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                // For non-baseline comparisons, show fields that exist in both versions OR should always be displayed
                                if (!shouldAlwaysDisplay && (string.IsNullOrEmpty(va) || string.IsNullOrEmpty(vb))) { continue; }
                                
                                bool diff = (va ?? "") != (vb ?? "");
                                
                                // Show all fields that exist in both versions (changed or not changed)
                                // But highlight only the changed ones
                                changedFieldsCount++;
                                var rowClassForDiff = diff ? "diff-yes" : "diff-no";
                                
                                <tr class="row-item @rowClassForDiff" data-field="@f">
                                    <td class="field-name">@friendlyFieldName</td>
                                    <td>
                                        <span class="old-badge">@Html.Raw(HttpUtility.HtmlEncode(string.IsNullOrEmpty(va) ? "(not set)" : va))</span>
                                    </td>
                                    <td>
                                        <span class="new-badge">@Html.Raw(HttpUtility.HtmlEncode(string.IsNullOrEmpty(vb) ? "(not set)" : vb))</span>
                                    </td>
                                </tr>
                            }
                        }
                    }
                    @if (changedFieldsCount == 0 && allFields.Count > 0)
                    {
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                <i class="fa fa-info-circle"></i> No changes found between these versions
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts{
<script>
    (function(){
        // Count and display changed fields
        var totalChanged = $('#cmpTable tbody tr.row-item').length;
        if (totalChanged > 0) {
            $('#changedCount').text('Total ' + totalChanged + ' field(s) changed');
        }
        
        function applyFilters(){
            var q = ($('#fltField').val() || '').toLowerCase();
            var q2 = ($('#fltField2').val() || '').toLowerCase();
            var qo = ($('#fltOld').val() || '').toLowerCase();
            var qn = ($('#fltNew').val() || '').toLowerCase();
            var visibleCount = 0;
            $('#cmpTable tbody tr').each(function(){
                var $tr = $(this);
                var fname = ($tr.data('field') + '').toLowerCase();
                var textOld = ($tr.find('td:nth-child(2)').text() || '').toLowerCase();
                var textNew = ($tr.find('td:nth-child(3)').text() || '').toLowerCase();
                var matchField = (!q && !q2) || fname.indexOf(q) !== -1 || fname.indexOf(q2) !== -1;
                var matchOld = !qo || textOld.indexOf(qo) !== -1;
                var matchNew = !qn || textNew.indexOf(qn) !== -1;
                var match = matchField && matchOld && matchNew;
                $tr.toggle(match);
                if (match && $tr.hasClass('row-item')) visibleCount++;
            });
            
            // Update count based on filter
            if (q || q2 || qo || qn) {
                $('#changedCount').text('Showing ' + visibleCount + ' of ' + totalChanged + ' changed field(s)');
            } else {
                $('#changedCount').text('Total ' + totalChanged + ' field(s) changed');
            }
        }
        $('#fltField').on('keyup change', applyFilters);
        $('#fltField2').on('keyup change', applyFilters);
        $('#fltOld').on('keyup change', applyFilters);
        $('#fltNew').on('keyup change', applyFilters);
    })();
</script>
}

